<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
          <h3>Color Prices Mapping</h3>
      <ul id="color-mapping-list" style="list-style: none">
      </ul>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.1.min.js"></script>
    <script src="https://cdn.firebase.com/v0/firebase.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script defer="defer">

      var mode = 0;
      var seatTypeCount = 0;
      var modeColor = [];
      var modeName = [];
      var modePrice = [];

      var stage = null;
      var layer = new Kinetic.Layer();
      var idLayer = new Kinetic.Layer();

      var json = "";
      var eventRef = new Firebase("https://ticketorder.firebaseio.com/template/1");
      eventRef.once('value', function(dataSnapshot) {
        var eventData = dataSnapshot.val();
        json = eventData.seatMap;
        stage = Kinetic.Node.create(json, 'container');

        idLayer = stage.find("#idLayer")[0];
        layer = stage.find("#seatLayer")[0];

        stage.add(idLayer);
        stage.add(layer);

        modeName = eventData.typeList;
        modeColor = eventData.colorList;
        modePrice = eventData.priceList;

        $("#color-mapping-list").empty();

        seatTypeCount = 0;

        for(var i = 0; i < modeName.length; i++) {
          addSeatType(true);
        }

        layer.getChildren().forEach(function (rect) {
          bindRectUserEvent(rect);
        });          

        layer.on("mouseup", function(e) {
          moving = false;
        });        

      });


      function bindRectUserEvent(rect) {
        rect.on('mousedown', function(e) {
          moving = true;
          if(this.getAttr('lockedBy') == _currentUserId) { // locked by current user, release it

            return;
          } else { // not locked by current user
            if(this.getAttr('lockedBy') != '') { // not locked by any user
              if(this.getAttr('available') == true) { // seat is available
                this.setAttr('lockedBy', _currentUserId);
                this.setAttr('available', false); // mark as not available
                this.fill('#f00');
                // update UI
                layer.draw();
              }
            }
          }
        });
      }        
      
    </script>
    <script src="./js/editorController.js"></script>
  </body>
</html>