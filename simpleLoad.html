<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <body>
    <div id="login_status"></div>
    Your Rest Ticket<div id="rest_ticket"></div>
    Your Ticket Type<div id="ticket_type"></div>
    <div id="container"></div>
          <h3>Color Prices Mapping</h3>
      <ul id="color-mapping-list" style="list-style: none">
      </ul>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.1.min.js"></script>
    <script src="https://cdn.firebase.com/v0/firebase.js"></script>
    <script src="./js/jquery.min.js"></script>
    <script src="./js/editorController.js"></script>
    <script defer="defer">
      var _eventId = getCookie("eventId");
       var _ticketNum = getCookie('ticketNum');
       var _ticketType = getCookie('ticketType');


        var seatListRef = new Firebase("https://ticketorder.firebaseio.com/event/" + _eventId + "/seatList/");


       $('#rest_ticket').html(_ticketNum);


      var _currentUserId = getCookie('userId');
      if(_currentUserId != "") {
        $("#login_status").empty();
        $("#login_status").append("<img src='https://graph.facebook.com/"+ _currentUserId + "/picture' />");      
      }



      var mode = 0;
      var seatTypeCount = 0;
      var modeColor = [];
      var modeName = [];
      var modePrice = [];

      var stage = null;
      var layer = new Kinetic.Layer();
      var idLayer = new Kinetic.Layer();

      var json = "";
      var eventRef = new Firebase("https://ticketorder.firebaseio.com/event/" + _eventId);
      eventRef.once('value', function(dataSnapshot) {
        var eventData = dataSnapshot.val();
        json = eventData.seatMap;
        stage = Kinetic.Node.create(json, 'container');

        idLayer = stage.find("#idLayer")[0];
        layer = stage.find("#seatLayer")[0];

        stage.add(idLayer);
        stage.add(layer);

        modeName = eventData.typeList;
        modeColor = eventData.colorList;
        modePrice = eventData.priceList;

        $("#color-mapping-list").empty();

        seatTypeCount = 0;

        for(var i = 0; i < modeName.length; i++) {
          addSeatType(true);
        }

        layer.getChildren().forEach(function (rect) {
          bindRectUserEvent(rect);
        });  


       $('#ticket_type').html(modeName[_ticketType]);
      });


      function bindRectUserEvent(rect) {
        rect.on('mousedown', function(e) {
          if(_ticketNum > 0) {
            if(this.getFill() != '#fff' && this.getFill() != '#000') { // don't click on white and black'
              var x = rect.getAttr('x');
              var y = rect.getAttr('y');
              var imageObj = new Image();
              imageObj.src = "https://graph.facebook.com/"+ _currentUserId + "/picture";
              imageObj.onload = function() {
              var img = new Kinetic.Image({
                x: x,
                y: y,
                image: imageObj,
                width: 30,
                height: 30
              });
              layer.add(img);

              img.on("mousedown", function(e) {
                img.destroy();
                _ticketNum++;
                $('#rest_ticket').html(_ticketNum);
                layer.draw();
                seatListRef.child(rect.getAttr('id')).remove();
              });
                // update UI
              layer.draw();
              _ticketNum--;
              $('#rest_ticket').html(_ticketNum);

              seatListRef.child(rect.getAttr('id')).set({
                userId: _currentUserId
              });
            }
            
          } 
        } else {
          alert("you don't have enough ticket");
        }

      });
      }

    
      
    </script>

  </body>
</html>